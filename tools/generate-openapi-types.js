const fs = require("fs");
const path = require("path");
const http = require("http");
const { spawnSync } = require("child_process");
const dotenv = require("dotenv");

dotenv.config();

const APPS = [
  {
    name: "api",
    port: process.env.API_SRV_PORT,
  },
  {
    name: "auth",
    port: process.env.AUTH_SRV_PORT,
  },
];

const OUT_DIR = path.resolve(__dirname, "../libs/data/src/typed-api");
const INDEX_FILE = path.resolve(__dirname, "../libs/data/src/index.ts");

function fetchJson(url) {
  return new Promise((resolve, reject) => {
    http
      .get(url, (res) => {
        if (res.statusCode !== 200) {
          reject(
            new Error(`Failed to fetch ${url} - status ${res.statusCode}`)
          );
          return;
        }
        let data = "";
        res.on("data", (chunk) => (data += chunk));
        res.on("end", () => {
          try {
            resolve(JSON.parse(data));
          } catch (err) {
            reject(err);
          }
        });
      })
      .on("error", reject);
  });
}

function updateIndexFile() {
  // Read existing index file or create empty string if it doesn't exist
  let indexContent = "";
  if (fs.existsSync(INDEX_FILE)) {
    indexContent = fs.readFileSync(INDEX_FILE, "utf8");
  }

  // Check and add exports for each app
  for (const app of APPS) {
    const typesExport = `export * as ${app.name}Types from "./typed-api/${app.name}.types.js";`;
    const clientExport = `export * from "./typed-api/${app.name}.client.js";`;

    // Add exports if they don't already exist
    if (!indexContent.includes(typesExport)) {
      indexContent += `\n${typesExport}\n`;
      console.log(
        `[generate-openapi-types] Added types export for "${app.name}" to index.ts`
      );
    }

    if (!indexContent.includes(clientExport)) {
      indexContent += `${clientExport}\n`;
      console.log(
        `[generate-openapi-types] Added client export for "${app.name}" to index.ts`
      );
    }
  }

  // Write updated content back to index file
  fs.writeFileSync(INDEX_FILE, indexContent);
  console.log("[generate-openapi-types] Updated index.ts with new exports");
}

async function generateTypes() {
  fs.mkdirSync(OUT_DIR, { recursive: true });

  // Generate types for each app
  for (const app of APPS) {
    // Fetch OpenAPI JSON docs from the app
    const swaggerUrl = `http://localhost:${app.port}/docs/json`;
    console.log(
      `[generate-openapi-types] Fetching OpenAPI JSON for "${app.name}" from "${swaggerUrl}"`
    );
    const json = await fetchJson(swaggerUrl);

    // Save JSON docs to a temp file
    const tmpJsonPath = path.join(OUT_DIR, `${app.name}-openapi-docs.json`);
    fs.writeFileSync(tmpJsonPath, JSON.stringify(json, null, 2));

    // Generate types
    const typesFile = `${app.name}.types.ts`;
    const typesPath = path.join(OUT_DIR, typesFile);
    console.log(`[generate-openapi-types] Generating types: "${typesPath}"`);
    const typeGen = spawnSync(
      "npx",
      ["openapi-typescript", tmpJsonPath, "--output", typesPath],
      { stdio: "inherit", shell: true }
    );
    if (typeGen.status !== 0) {
      console.error(
        `[generate-openapi-types] Failed to generate types for "${app.name}"`,
        typeGen.error
      );
      process.exit(typeGen.status);
    }

    // Generate a typed client using openapi-fetch and use the generated types above
    const clientFile = `${app.name}.client.ts`;
    const relTypesImport = `./${path.basename(typesFile)}`;
    const clientPath = path.join(OUT_DIR, clientFile);
    const clientCode = `
// Auto-generated by \`tools/generate-openapi-types.js\`
import createClient from 'openapi-fetch';
import type { paths } from '${relTypesImport}';

export const ${app.name}Client = createClient<paths>({
  baseUrl: 'http://localhost:${app.port}',
});
`;
    fs.writeFileSync(clientPath, clientCode.trimStart());
    console.log(`[generate-openapi-types] Generated client: ${clientPath}`);

    // Remove temp JSON docs file
    fs.unlinkSync(tmpJsonPath);
  }

  // Update index.ts file with exports
  updateIndexFile();
}

generateTypes().catch((err) => {
  console.error("[generate-openapi-types] Failed:", err);
  process.exit(1);
});
